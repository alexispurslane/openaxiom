<!-- Search component for OpenAxiom TTRPG manual -->
<style>
.search-container {
    display: inline-block;
    margin-left: 1em;
    position: relative;
}

.search-box {
    padding: 4px 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 14px;
    width: 150px;
}

.search-results {
    position: absolute;
    top: 100%;
    right: 0;
    width: 300px;
    max-height: 400px;
    overflow-y: auto;
    background: white;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-top: 5px;
    display: none;
    z-index: 1001;
}

.search-result {
    padding: 10px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
}

.search-result:last-child {
    border-bottom: none;
}

.search-result:hover {
    background-color: #f5f5f5;
}

.search-result-title {
    font-weight: bold;
    color: #333;
}

.search-result-content {
    font-size: 12px;
    color: #666;
    margin-top: 5px;
}

.highlight {
    background-color: yellow;
    font-weight: bold;
}
</style>

<div class="search-container">
    <input type="text" class="search-box" placeholder="Search..." id="searchBox">
    <div class="search-results" id="searchResults"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchBox = document.getElementById('searchBox');
    const searchResults = document.getElementById('searchResults');
    
    searchBox.addEventListener('input', function() {
        const query = this.value.trim();
        
        if (query.length === 0) {
            searchResults.style.display = 'none';
            return;
        }
        
        // Perform search
        fetch(`/api/search?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(results => {
                displayResults(results, query);
            })
            .catch(error => {
                console.error('Search error:', error);
            });
    });
    
    function highlightText(text, query) {
        if (!query) return text;
        // Split query into individual terms
        const terms = query.trim().split(/\s+/);
        // Escape special regex characters in each term
        const escapedTerms = terms.map(term => term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'));
        // Create a regex pattern that matches any of the terms
        const pattern = escapedTerms.join('|');
        const regex = new RegExp(`(${pattern})`, 'gi');
        return text.replace(regex, '<span class="highlight">$1</span>');
    }
    
    function displayResults(results, query) {
        if (results.length === 0) {
            searchResults.innerHTML = '<div class="search-result">No results found</div>';
        } else {
            searchResults.innerHTML = results.map(result => {
                // Highlight the search terms in the content and title
                const highlightedContent = highlightText(result.content, query);
                const highlightedTitle = highlightText(result.title, query);
                
                // Generate link URL with section ID if available
                let linkUrl = `/${result.path.replace('.org', '.html')}`;
                if (result.section_id) {
                    linkUrl += `#${result.section_id}?search=${encodeURIComponent(query)}`;
                } else {
                    // If no section ID, put search in query parameters
                    linkUrl += `?search=${encodeURIComponent(query)}`;
                }
                
                return `
                    <div class="search-result" onclick="window.location.href='${linkUrl}'">
                        <div class="search-result-title">${highlightedTitle}</div>
                        <div class="search-result-content">${highlightedContent}</div>
                    </div>
                `;
            }).join('');
        }
        searchResults.style.display = 'block';
    }
    
    // Close search results when clicking outside
    document.addEventListener('click', function(event) {
        if (!searchBox.contains(event.target) && !searchResults.contains(event.target)) {
            searchResults.style.display = 'none';
        }
    });
    
    // Highlight search terms when page loads with search parameter
    function highlightSearchTerms() {
        // Get search query from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        let searchQuery = urlParams.get('search');
        
        // If no search query in URL parameters, check hash for parameters
        if (!searchQuery) {
            // Extract parameters from hash
            const hash = window.location.hash;
            const hashParts = hash.split('?');
            if (hashParts.length > 1) {
                const hashParams = new URLSearchParams(hashParts[1]);
                searchQuery = hashParams.get('search');
            }
        }
        
        if (searchQuery) {
            highlightTextOnPage(decodeURIComponent(searchQuery));
        }
    }
    
    // Highlight text on the page
    function highlightTextOnPage(query) {
        if (!query) return;
        
        // Split query into individual terms
        const terms = query.trim().split(/\s+/);
        if (terms.length === 0) return;
        
        // Create a regex pattern that matches any of the terms
        const escapedTerms = terms.map(term => term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'));
        const pattern = escapedTerms.join('|');
        const regex = new RegExp(`(${pattern})`, 'gi');
        
        // Function to highlight text nodes
        function highlightNode(node) {
            // Skip script and style elements
            if (node.nodeType === Node.ELEMENT_NODE && 
                (node.tagName === 'SCRIPT' || node.tagName === 'STYLE')) {
                return;
            }
            
            // Process child nodes
            if (node.nodeType === Node.TEXT_NODE) {
                const text = node.nodeValue;
                const matches = text.match(regex);
                
                if (matches) {
                    const span = document.createElement('span');
                    span.innerHTML = text.replace(regex, '<span class="highlight">$1</span>');
                    
                    // Replace the text node with highlighted spans
                    const parent = node.parentNode;
                    while (span.firstChild) {
                        parent.insertBefore(span.firstChild, node);
                    }
                    parent.removeChild(node);
                }
            } else if (node.nodeType === Node.ELEMENT_NODE) {
                // Process child nodes
                const childNodes = Array.from(node.childNodes);
                childNodes.forEach(highlightNode);
            }
        }
        
        // Highlight text in the main content area
        const mainContent = document.querySelector('main') || document.body;
        highlightNode(mainContent);
        
        // Scroll to first highlighted element
        const firstHighlight = document.querySelector('.highlight');
        if (firstHighlight) {
            firstHighlight.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }
    
    // Run highlight function when page loads
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', highlightSearchTerms);
    } else {
        highlightSearchTerms();
    }
});
</script>